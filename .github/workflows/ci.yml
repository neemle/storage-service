name: CI/CD

on:
  push:
    branches:
      - "**"
    tags:
      - "*"
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  stage-1-unit:
    name: Stage 1 - Unit
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Print checked out commit
        run: git rev-parse HEAD

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.93"
          components: rustfmt, clippy

      - name: Check line and function limits
        run: python3 scripts/quality-check.py

      - name: Enforce Rust format
        run: cargo fmt --all -- --check

      - name: Enforce strict Rust lints (production targets)
        run: cargo clippy --workspace -- -D warnings

      - name: Install cargo-audit
        run: |
          if ! cargo audit --version >/dev/null 2>&1; then
            cargo install cargo-audit --locked
          fi

      - name: Run Rust security audit
        run: ./scripts/security-audit.sh

      - name: Set up Docker Buildx for unit test image cache
        uses: docker/setup-buildx-action@v3

      - name: Build cached unit test runner image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/test-runner.Dockerfile
          tags: nss-test-runner:ci-cached
          load: true
          cache-from: type=gha,scope=unit-test-runner
          cache-to: type=gha,mode=max,scope=unit-test-runner,ignore-error=true

      - name: Run backend unit tests
        run: |
          set -euo pipefail
          NSS_TEST_IMAGE=nss-test-runner:ci-cached \
          NSS_TEST_SHARDS=6 NSS_TEST_THREADS=1 NSS_TEST_PROFILE=test \
          NSS_UNIT_COVERAGE_LINES=100 NSS_UNIT_COVERAGE_FUNCTIONS=100 \
          NSS_UNIT_COVERAGE_REGIONS=100 NSS_UNIT_COVERAGE_BRANCHES=100 \
          ./scripts/unit-tests.sh

      - name: Prepare backend unit diagnostics
        if: failure()
        run: |
          set -euo pipefail
          OUT_DIR=".artifacts/backend-unit-diagnostics"
          mkdir -p "$OUT_DIR"

          {
            echo "run_id=${{ github.run_id }}"
            echo "job=stage-1-unit"
            echo "sha=${{ github.sha }}"
            echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } > "$OUT_DIR/meta.txt"

          if [ -d scripts/tmp/unit-shards ]; then
            cp -a scripts/tmp/unit-shards "$OUT_DIR/unit-shards"
          fi

          docker compose -p deploy_unit -f deploy/docker-compose.test.yml ps \
            > "$OUT_DIR/compose-ps.txt" 2>&1 || true
          docker compose -p deploy_unit -f deploy/docker-compose.test.yml logs \
            --no-color --tail=400 postgres redis rabbitmq \
            > "$OUT_DIR/compose-services.log" 2>&1 || true

          if [ -d target/llvm-cov-target ]; then
            find target/llvm-cov-target -maxdepth 2 -type f | sort \
              > "$OUT_DIR/llvm-cov-target-files.txt" || true
          fi
          if [ -d target/llvm-cov-build ]; then
            find target/llvm-cov-build -maxdepth 2 -type f | sort \
              > "$OUT_DIR/llvm-cov-build-files.txt" || true
          fi

      - name: Upload backend unit diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-unit-diagnostics
          if-no-files-found: ignore
          path: .artifacts/backend-unit-diagnostics

      - name: Run UI unit tests (dockerized)
        run: ./scripts/ui-unit-tests.sh

      - name: Upload UI unit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-unit-artifacts
          if-no-files-found: ignore
          path: test-results/ui-unit

  stage-2-integration:
    name: Stage 2 - Integration
    runs-on: ubuntu-latest
    needs: stage-1-unit
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Run backend integration tests
        run: |
          NSS_INTEGRATION_COVERAGE_LINES=100 NSS_INTEGRATION_COVERAGE_FUNCTIONS=100 \
          NSS_INTEGRATION_COVERAGE_REGIONS=100 NSS_INTEGRATION_COVERAGE_BRANCHES=100 \
          ./scripts/integration-tests.sh

      - name: Run UI integration tests (dockerized)
        run: ./scripts/ui-integration-tests.sh

      - name: Run external auth infrastructure tests
        run: ./scripts/external-auth-tests.sh

      - name: Run cluster tests
        run: ./scripts/cluster-tests.sh

      - name: Run memory leak checks
        run: ./scripts/memory-leak-check.sh

      - name: Upload UI integration artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-integration-artifacts
          if-no-files-found: ignore
          path: test-results/ui-integration

      - name: Upload external auth artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: external-auth-artifacts
          if-no-files-found: ignore
          path: test-results/external-auth

      - name: Upload memcheck artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: memcheck-artifacts
          if-no-files-found: ignore
          path: test-results/memcheck

  stage-3-curl:
    name: Stage 3 - Curl Runtime/Dev
    runs-on: ubuntu-latest
    needs: stage-2-integration
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Run curl tests
        run: ./scripts/curl-tests.sh

      - name: Run integration curl journey tests
        run: ./scripts/it.sh

  stage-4-base-ui:
    name: Stage 4 - Base UI
    runs-on: ubuntu-latest
    needs: stage-3-curl
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Run base UI Playwright tests
        env:
          NSS_PLAYWRIGHT_PROJECTS: base
        run: ./scripts/ui-tests.sh

      - name: Upload base UI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-base-artifacts
          if-no-files-found: ignore
          path: test-results/ui-base

  stage-5-ui:
    name: Stage 5 - UI
    runs-on: ubuntu-latest
    needs: stage-4-base-ui
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4

      - name: Run full UI Playwright tests
        env:
          NSS_PLAYWRIGHT_PROJECTS: base ui
        run: ./scripts/ui-tests.sh

      - name: Upload UI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-ui-artifacts
          if-no-files-found: ignore
          path: test-results/ui-tests

  stage-6-runtime:
    name: Stage 6 - Runtime Production API Image
    runs-on: ubuntu-latest
    needs: stage-5-ui
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Run runtime curl tests
        run: ./scripts/runtime-tests.sh

  stage-7-production:
    name: Stage 7 - Production Fullstack
    runs-on: ubuntu-latest
    needs: stage-6-runtime
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Verify master distroless static image
        run: ./scripts/verify-distroless.sh nss-ci-master ${{ github.sha }} master

      - name: Verify replica distroless static image
        run: ./scripts/verify-distroless.sh nss-ci-replica ${{ github.sha }} replica

      - name: Run production tests
        run: ./scripts/production-tests.sh

      - name: Upload production artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-production-artifacts
          if-no-files-found: ignore
          path: test-results/production

  release:
    name: Release Binaries
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: stage-7-production
    timeout-minutes: 120
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Build cross-platform binaries
        run: npm run build:dist -- all

      - name: Package release artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release

          for platform_dir in dist/*; do
            [ -d "$platform_dir" ] || continue
            platform_name=$(basename "$platform_dir")

            if [ -f "$platform_dir/nss.exe" ]; then
              (
                cd dist
                zip -j "../release/neemle-storage-service-${platform_name}.zip" "${platform_name}/nss.exe"
              )
            elif [ -f "$platform_dir/nss" ]; then
              tar -C dist -czf "release/neemle-storage-service-${platform_name}.tar.gz" "${platform_name}/nss"
            fi
          done

          if [ -d dist/ui ]; then
            tar -C dist -czf release/neemle-storage-service-ui.tar.gz ui
          fi

          sha256sum release/* > release/SHA256SUMS.txt

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
